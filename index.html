<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERP - Miranda Ferragens</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        padding: 0;
        color: #333;
    }

    header {
        background: linear-gradient(90deg, #3498db, #2ecc71);
        color: white;
        padding: 25px 20px;
        text-align: center;
        font-size: 28px;
        font-weight: bold;
        letter-spacing: 2px;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 15px;
    }

    .container {
        display: flex;
        flex-wrap: wrap;
        padding: 20px;
        gap: 20px;
    }

    .box {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        flex: 1 1 400px;
        min-width: 300px;
    }

    h2 { margin-top: 0; color: #2c3e50; }

    input, button {
        padding: 10px;
        margin: 5px 0;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 16px;
    }

    input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 5px rgba(52,152,219,0.5);
    }

    button {
        background-color: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        transition: 0.2s;
    }

    button:hover { background-color: #2980b9; }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    table th, table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    table th { background-color: #3498db; color: white; }

    .btn-small { padding: 6px 10px; font-size: 14px; border-radius: 5px; margin-right: 5px; }
    .btn-vender { background-color: #27ae60; }
    .btn-vender:hover { background-color: #1e8449; }
    .btn-excluir { background-color: #e74c3c; }
    .btn-excluir:hover { background-color: #c0392b; }
    .btn-export { background-color: #8e44ad; margin-top: 10px; }
    .btn-export:hover { background-color: #732d91; }

    .flex-row { display: flex; gap: 10px; flex-wrap: wrap; }

    /* Responsividade total */
    @media (max-width: 1200px) { .container { flex-direction: column; } }
    @media (max-width: 600px) { input, button { width: 100%; } table th, table td { font-size: 14px; } }
</style>
</head>
<body>

<header>üõ†Ô∏è Miranda Ferragens üõ†Ô∏è</header>

<div class="container">

    <!-- Box 1: Cadastro e pesquisa -->
    <div class="box">
        <h2>Cadastrar Produto</h2>
        <input type="text" id="nomeProduto" placeholder="Nome do produto">
        <input type="number" id="precoProduto" placeholder="Pre√ßo">
        <input type="number" id="quantidadeProduto" placeholder="Quantidade">
        <button onclick="cadastrarProduto()">Cadastrar</button>

        <h2>Produtos</h2>
        <input type="text" id="pesquisaProduto" placeholder="Pesquisar produto" oninput="atualizarTabelaProdutos()">
        <table id="tabelaProdutos">
            <thead>
                <tr><th>Nome</th><th>Pre√ßo</th><th>Qtd</th><th>A√ß√£o</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Box 2: Modo de venda -->
    <div class="box">
        <h2>Venda / Pedido</h2>
        <table id="carrinho">
            <thead>
                <tr><th>Produto</th><th>Pre√ßo</th><th>Qtd</th><th>Subtotal</th><th>Remover</th></tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="flex-row">
            <input type="number" id="desconto" placeholder="Desconto (%)" min="0" max="100" value="0" oninput="atualizarTotal()">
            <input type="number" id="valorPago" placeholder="Valor Pago (R$)" min="0" oninput="atualizarTroco()">
        </div>
        <p>Total: R$ <span id="totalVenda">0.00</span></p>
        <p>Troco: R$ <span id="troco">0.00</span></p>
        <button onclick="concluirVenda()">Concluir Venda</button>

        <h2>Hist√≥rico de Vendas</h2>
        <table id="tabelaVendas">
            <thead>
                <tr><th>Produto</th><th>Pre√ßo</th><th>Qtd</th><th>Total</th><th>Data</th><th>A√ß√£o</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn-export" onclick="exportarCSV()">Exportar Vendas CSV</button>
    </div>

</div>

<script>
const LS_PRODUTOS = "produtosMiranda";
const LS_VENDAS = "vendasMiranda";
let produtos = JSON.parse(localStorage.getItem(LS_PRODUTOS)) || [];
let vendas = JSON.parse(localStorage.getItem(LS_VENDAS)) || [];
let carrinho = [];

// Salvar no localStorage
function salvarLocalStorage() {
    localStorage.setItem(LS_PRODUTOS, JSON.stringify(produtos));
    localStorage.setItem(LS_VENDAS, JSON.stringify(vendas));
}

// Cadastro
function cadastrarProduto() {
    const nome = document.getElementById("nomeProduto").value.trim();
    const preco = parseFloat(document.getElementById("precoProduto").value);
    const quantidade = parseInt(document.getElementById("quantidadeProduto").value);
    if (!nome || isNaN(preco) || isNaN(quantidade)) { alert("Preencha todos os campos corretamente!"); return; }
    produtos.push({ nome, preco, quantidade });
    salvarLocalStorage();
    atualizarTabelaProdutos();
    document.getElementById("nomeProduto").value = "";
    document.getElementById("precoProduto").value = "";
    document.getElementById("quantidadeProduto").value = "";
}

// Tabela de produtos com filtro
function atualizarTabelaProdutos() {
    const tbody = document.getElementById("tabelaProdutos").querySelector("tbody");
    tbody.innerHTML = "";
    const filtro = document.getElementById("pesquisaProduto").value.toLowerCase();
    produtos.forEach((p, i) => {
        if (p.nome.toLowerCase().includes(filtro)) {
            const row = tbody.insertRow();
            row.insertCell(0).innerText = p.nome;
            row.insertCell(1).innerText = p.preco.toFixed(2);
            row.insertCell(2).innerText = p.quantidade;
            const btn = document.createElement("button");
            btn.className = "btn-small btn-vender";
            btn.innerText = "Adicionar";
            btn.onclick = () => adicionarCarrinho(i);
            row.insertCell(3).appendChild(btn);
        }
    });
}

// Carrinho
function adicionarCarrinho(index) {
    const produto = produtos[index];
    if (produto.quantidade === 0) { alert("Produto sem estoque!"); return; }
    const existente = carrinho.find(item => item.nome === produto.nome);
    if (existente) {
        if (existente.qtd < produto.quantidade) { existente.qtd++; }
        else { alert("Estoque insuficiente!"); return; }
    } else {
        carrinho.push({ nome: produto.nome, preco: produto.preco, qtd: 1 });
    }
    atualizarCarrinho();
}

function removerDoCarrinho(index) {
    carrinho.splice(index, 1);
    atualizarCarrinho();
}

function atualizarCarrinho() {
    const tbody = document.getElementById("carrinho").querySelector("tbody");
    tbody.innerHTML = "";
    carrinho.forEach((item, i) => {
        const row = tbody.insertRow();
        row.insertCell(0).innerText = item.nome;
        row.insertCell(1).innerText = item.preco.toFixed(2);
        row.insertCell(2).innerText = item.qtd;
        row.insertCell(3).innerText = (item.preco*item.qtd).toFixed(2);
        const btn = document.createElement("button");
        btn.className = "btn-small btn-excluir";
        btn.innerText = "Remover";
        btn.onclick = () => removerDoCarrinho(i);
        row.insertCell(4).appendChild(btn);
    });
    atualizarTotal();
    atualizarTroco();
}

// Total e troco
function atualizarTotal() {
    const subtotal = carrinho.reduce((acc, i) => acc + i.preco*i.qtd, 0);
    const descontoPct = parseFloat(document.getElementById("desconto").value) || 0;
    const total = subtotal * (1 - descontoPct/100);
    document.getElementById("totalVenda").innerText = total.toFixed(2);
}

function atualizarTroco() {
    const valorPago = parseFloat(document.getElementById("valorPago").value) || 0;
    const total = parseFloat(document.getElementById("totalVenda").innerText);
    const troco = valorPago - total;
    document.getElementById("troco").innerText = troco >= 0 ? troco.toFixed(2) : "0.00";
}

// Concluir venda com baixa de estoque persistente
function concluirVenda() {
    if (carrinho.length === 0) { alert("Carrinho vazio!"); return; }
    const total = parseFloat(document.getElementById("totalVenda").innerText);
    const valorPago = parseFloat(document.getElementById("valorPago").value) || 0;
    if (valorPago < total) { alert("Valor pago insuficiente!"); return; }

    for (let item of carrinho) {
        const produto = produtos.find(p => p.nome === item.nome);
        if (produto) {
            if (produto.quantidade >= item.qtd) {
                produto.quantidade -= item.qtd;
            } else {
                alert(`Estoque insuficiente para o produto ${produto.nome}.`);
                return;
            }
        }
        vendas.push({
            nome: item.nome,
            preco: item.preco,
            qtd: item.qtd,
            total: item.preco*item.qtd,
            data: new Date().toLocaleString()
        });
    }

    carrinho = [];
    document.getElementById("desconto").value = 0;
    document.getElementById("valorPago").value = 0;

    salvarLocalStorage();
    atualizarCarrinho();
    atualizarTabelaProdutos();
    atualizarTabelaVendas();
}

// Atualizar hist√≥rico de vendas
function atualizarTabelaVendas() {
    const tbody = document.getElementById("tabelaVendas").querySelector("tbody");
    tbody.innerHTML = "";
    vendas.forEach((v, index) => {
        const row = tbody.insertRow();
        row.insertCell(0).innerText = v.nome;
        row.insertCell(1).innerText = v.preco.toFixed(2);
        row.insertCell(2).innerText = v.qtd;
        row.insertCell(3).innerText = v.total.toFixed(2);
        row.insertCell(4).innerText = v.data;

        const btn = document.createElement("button");
        btn.className = "btn-small btn-excluir";
        btn.innerText = "Excluir";
        btn.onclick = () => excluirVenda(index);
        row.insertCell(5).appendChild(btn);
    });
}

// Excluir venda e atualizar estoque
function excluirVenda(index) {
    const venda = vendas[index];
    const produto = produtos.find(p => p.nome === venda.nome);
    if (produto) produto.quantidade += venda.qtd; // Reposi√ß√£o do estoque
    vendas.splice(index, 1);
    salvarLocalStorage();
    atualizarTabelaProdutos();
    atualizarTabelaVendas();
}

// Exportar CSV
function exportarCSV() {
    if (vendas.length === 0) { alert("N√£o h√° vendas para exportar!"); return; }
    let csv = "Produto,Pre√ßo,Qtd,Total,Data\n";
    vendas.forEach(v => {
        csv += `"${v.nome}",${v.preco.toFixed(2)},${v.qtd},${v.total.toFixed(2)},"${v.data}"\n`;
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "vendas_miranda_ferragens.csv";
    link.click();
}

// Inicializa√ß√£o
atualizarTabelaProdutos();
atualizarCarrinho();
atualizarTabelaVendas();

</script>

</body>
</html>
